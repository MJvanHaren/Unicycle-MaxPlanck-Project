#include "control.h"
/**************************************************************************
 *
 *  Variables
 *
 **************************************************************************/
#if LOOP_FREQ == 700
float K[3] = {-17.470429, -9.010758, -0.006536}; // control gains 700 Hz
float Ki = 0.001;
#elif LOOP_FREQ == 600
float K[3] = {-16.951828, -8.719625, -0.006323}; // control gains 600 Hz
float Ki = 0.0009;
#elif LOOP_FREQ == 500
float K[3] = {-16.270985, -8.337422, -0.006043}; // control gains 500 Hz
float Ki = 0.0008;
#elif LOOP_FREQ == 400
float K[3] = {-15.338372, -7.813904, -0.005661}; // control gains 400 Hz
float Ki = 0.0007;
#elif LOOP_FREQ == 300
float K[3] = {-13.985230, -7.054378, -0.005106}; // control gains 300 Hz
float Ki = 0.0006;
#elif LOOP_FREQ == 200
float K[3] = {-11.857025, -5.859989, -0.004233}; // control gains 200 Hz
// float K[3] = {-15.093905, -7.693763, -0.005574 }; // control gains 200 Hz 25000 r
float Ki = 0.0004;
#elif LOOP_FREQ == 100
float K[3] = {-8.125667, -3.767004, -0.002702}; // control gains 100 Hz
float Ki = 0.0003;
#elif LOOP_FREQ == 50
float K[3] = {-5.177455, -2.116678, -0.001493}; // control gains 50 Hz
float Ki = 0.00013;
#else
float K[3] = {0, 0, 0}; // no correct loop freq? -> no gains.
float Ki = 0.0;
#endif

#if PROTRACTOR_ANGLE == 20000
#define TRAJ_LENGTH 116
int theta_traj[TRAJ_LENGTH] = {
    10472, 10469, 10462, 10449, 10431, 10409, 10382, 10351, 10315, 10274, 10230, 10181, 10129, 10072, 10011, 9947, 9879,
    9807,  9731,  9651,  9568,  9482,  9391,  9298,  9200,  9100,  8995,  8888,  8776,  8661,  8543,  8421,  8296, 8167,
    8034,  7898,  7758,  7614,  7467,  7315,  7160,  7001,  6841,  6677,  6511,  6344,  6176,  6007,  5837,  5667, 5497,
    5327,  5158,  4989,  4821,  4655,  4490,  4326,  4165,  4005,  3847,  3691,  3538,  3388,  3240,  3094,  2951, 2812,
    2675,  2542,  2412,  2285,  2161,  2041,  1924,  1810,  1700,  1594,  1492,  1393,  1297,  1206,  1118,  1033, 953,
    876,   803,   733,   667,   605,   546,   491,   440,   391,   347,   305,   267,   232,   201,   172,   146,  123,
    103,   85,    70,    57,    46,    37,    30,    25,    21,    19,    17,    17,    17,    18};
int dthetadt_traj[TRAJ_LENGTH] = {
    0,      -347,   -684,   -1013,  -1334,  -1647,  -1952,  -2251,  -2543,  -2828,  -3107,  -3382,  -3651,
    -3915,  -4175,  -4430,  -4682,  -4931,  -5177,  -5420,  -5659,  -5897,  -6134,  -6370,  -6604,  -6837,
    -7069,  -7302,  -7535,  -7769,  -8004,  -8240,  -8476,  -8714,  -8955,  -9199,  -9446,  -9696,  -9949,
    -10239, -10527, -10748, -10901, -10987, -11103, -11200, -11275, -11327, -11355, -11363, -11355, -11330,
    -11289, -11231, -11156, -11069, -10970, -10859, -10737, -10602, -10457, -10303, -10141, -9971,  -9793,
    -9606,  -9413,  -9214,  -9009,  -8799,  -8583,  -8363,  -8139,  -7911,  -7679,  -7444,  -7206,  -6966,
    -6725,  -6481,  -6236,  -5989,  -5743,  -5496,  -5249,  -5002,  -4757,  -4512,  -4270,  -4028,  -3789,
    -3553,  -3321,  -3091,  -2866,  -2645,  -2429,  -2218,  -2014,  -1815,  -1624,  -1439,  -1263,  -1095,
    -936,   -787,   -648,   -519,   -402,   -297,   -204,   -124,   -58,    -7,     29,     49};

int omega_traj[TRAJ_LENGTH] = {
    0,     265,   528,   788,   1046,  1302,  1556,  1808,  2057,  2304,  2549,  2792,  3033,  3272,  3508,
    3743,  3975,  4206,  4435,  4661,  4886,  5109,  5330,  5549,  5766,  5981,  6195,  6406,  6616,  6824,
    7031,  7235,  7438,  7639,  7839,  8036,  8233,  8427,  8620,  8819,  9016,  9193,  9351,  9490,  9633,
    9769,  9897,  10016, 10126, 10229, 10324, 10413, 10495, 10570, 10637, 10699, 10755, 10805, 10850, 10889,
    10922, 10951, 10975, 10995, 11009, 11019, 11025, 11028, 11026, 11021, 11012, 10999, 10984, 10965, 10944,
    10919, 10892, 10863, 10831, 10797, 10761, 10723, 10684, 10643, 10600, 10556, 10511, 10465, 10418, 10370,
    10322, 10274, 10225, 10177, 10128, 10080, 10033, 9986,  9940,  9895,  9851,  9808,  9767,  9728,  9691,
    9655,  9622,  9592,  9564,  9539,  9516,  9497,  9482,  9469,  9461,  9456};
int torque_traj[TRAJ_LENGTH] = {
    11250, 11154, 11058, 10963, 10869, 10776, 10684, 10592, 10502, 10412, 10323, 10234, 10147, 10060, 9974,
    9888,  9804,  9720,  9636,  9554,  9472,  9391,  9311,  9231,  9152,  9074,  8996,  8919,  8843,  8767,
    8692,  8617,  8544,  8470,  8398,  8326,  8255,  8184,  8114,  8033,  7582,  7151,  6739,  6346,  5963,
    5593,  5237,  4893,  4562,  4243,  3935,  3638,  3351,  3074,  2806,  2548,  2299,  2058,  1826,  1602,
    1386,  1177,  976,   782,   595,   416,   243,   77,    -83,   -235,  -382,  -522,  -655,  -783,  -904,
    -1018, -1127, -1229, -1325, -1415, -1498, -1576, -1647, -1711, -1769, -1821, -1866, -1905, -1937, -1962,
    -1981, -1993, -1998, -1996, -1988, -1972, -1949, -1919, -1881, -1837, -1785, -1726, -1659, -1585, -1503,
    -1414, -1317, -1213, -1101, -982,  -855,  -721,  -579,  -429,  -273,  0};
#elif PROTRACTOR_ANGLE == 30000
#define TRAJ_LENGTH 112
int theta_traj[TRAJ_LENGTH] = {
    15708, 15702, 15686, 15660, 15623, 15577, 15522, 15457, 15384, 15302, 15213, 15115, 15010, 14897, 14777, 14650,
    14517, 14377, 14230, 14077, 13918, 13754, 13583, 13406, 13224, 13037, 12844, 12646, 12443, 12234, 12020, 11801,
    11577, 11348, 11114, 10875, 10630, 10381, 10130, 9876,  9619,  9361,  9102,  8843,  8583,  8324,  8065,  7809,
    7553,  7300,  7047,  6798,  6552,  6308,  6068,  5830,  5596,  5367,  5141,  4919,  4701,  4488,  4279,  4075,
    3875,  3680,  3490,  3305,  3125,  2951,  2781,  2617,  2457,  2304,  2155,  2012,  1874,  1742,  1615,  1494,
    1378,  1267,  1162,  1062,  967,   878,   794,   716,   642,   573,   510,   451,   397,   348,   304,   263,
    227,   196,   168,   144,   123,   106,   92,    81,    73,    67,    63,    61,    61,    62,    64,    66};
int dthetadt_traj[TRAJ_LENGTH] = {
    0,      -729,   -1432,  -2111,  -2766,  -3399,  -4010,  -4601,  -5172,  -5724,  -6259,  -6778,  -7279,  -7764,
    -8236,  -8695,  -9141,  -9573,  -9993,  -10405, -10807, -11199, -11582, -11956, -12324, -12687, -13044, -13396,
    -13743, -14084, -14423, -14760, -15097, -15432, -15767, -16100, -16524, -16839, -17031, -17100, -17168, -17256,
    -17310, -17332, -17319, -17276, -17211, -17123, -17013, -16880, -16723, -16551, -16364, -16162, -15944, -15711,
    -15465, -15209, -14943, -14667, -14381, -14085, -13782, -13472, -13156, -12833, -12504, -12169, -11830, -11487,
    -11141, -10790, -10436, -10080, -9723,  -9363,  -9002,  -8639,  -8277,  -7915,  -7554,  -7192,  -6832,  -6475,
    -6120,  -5768,  -5418,  -5073,  -4733,  -4398,  -4068,  -3745,  -3430,  -3121,  -2822,  -2532,  -2251,  -1981,
    -1724,  -1478,  -1246,  -1028,  -825,   -638,   -468,   -316,   -182,   -69,    24,     95,     143,    168};
int omega_traj[TRAJ_LENGTH] = {
    0,     442,   877,   1306,  1728,  2145,  2555,  2960,  3358,  3751,  4139,  4520,  4897,  5267,  5633,  5993,
    6348,  6698,  7043,  7383,  7718,  8049,  8374,  8695,  9011,  9323,  9631,  9934,  10233, 10527, 10817, 11103,
    11386, 11664, 11938, 12209, 12497, 12755, 12979, 13168, 13354, 13539, 13712, 13873, 14021, 14157, 14284, 14401,
    14508, 14604, 14691, 14770, 14841, 14904, 14959, 15007, 15047, 15080, 15107, 15128, 15143, 15151, 15154, 15152,
    15145, 15133, 15116, 15094, 15068, 15038, 15004, 14966, 14924, 14879, 14831, 14781, 14727, 14670, 14611, 14551,
    14488, 14423, 14357, 14289, 14221, 14151, 14081, 14010, 13939, 13868, 13797, 13727, 13658, 13589, 13522, 13456,
    13392, 13330, 13271, 13214, 13159, 13108, 13061, 13017, 12976, 12941, 12909, 12883, 12861, 12845, 12834, 12829};
int torque_traj[TRAJ_LENGTH] = {
    18750, 18482, 18218, 17958, 17702, 17449, 17201, 16955, 16713, 16475, 16240, 16009, 15781, 15556, 15334, 15116,
    14900, 14688, 14479, 14273, 14070, 13869, 13672, 13477, 13285, 13096, 12910, 12726, 12545, 12366, 12190, 12017,
    11846, 11677, 11510, 11346, 10673, 9993,  9356,  8758,  8184,  7629,  7100,  6595,  6112,  5650,  5208,  4784,
    4378,  3988,  3615,  3256,  2912,  2581,  2262,  1956,  1662,  1379,  1107,  845,   594,   352,   119,   -104,
    -318,  -524,  -720,  -909,  -1089, -1260, -1424, -1579, -1726, -1865, -1996, -2118, -2233, -2338, -2436, -2525,
    -2605, -2677, -2739, -2793, -2838, -2873, -2899, -2915, -2921, -2918, -2904, -2880, -2846, -2801, -2745, -2679,
    -2601, -2513, -2413, -2301, -2179, -2044, -1899, -1741, -1573, -1392, -1200, -997,  -783,  -557,  -320,  0};
#else
#define TRAJ_LENGTH 10
int theta_traj[TRAJ_LENGTH] = {0};
int torque_traj[TRAJ_LENGTH] = {0};
int dthetadt_traj[TRAJ_LENGTH] = {0};
int omega_traj[TRAJ_LENGTH] = {0};
#endif

float desired_omega = 0.0;
float desired_theta = 0.0;
float desired_thetad = 0.0;
float thetadd = 0.0;

float integrate_omega = 0.0;
/**************************************************************************
 *
 *  Functions
 *
 **************************************************************************/

//! \brief Saturate torque out of control loop to set torque in config
//! \param[in] torque, torque which needs to be saturated
//! \param[in] omega, used so torque/speed curve is not exceeded as well
//! \param[out] float value of torque which is saturated to set max/min
float saturate_torque(float torque, float omega, float dCurrent) {
  // saturate torque of motor, so abs. current draw is lower or equal than a set value in config.h
  // also saturates to torque/speed curve

  float output = 0;
  float max_torque = MOTOR_TORQUE_CONSTANT * (MAX_CURRENT_MOTOR - dCurrent) *
                     (1.0 - fabsf(omega / ((float)MOTOR_KV * MOTOR_V / 60.0 * 2.0 * PI)));
  if (torque >= max_torque) {
    output = max_torque;
  } else if (torque <= -max_torque) {
    output = -max_torque;
  } else {
    output = torque;
  }
  return output;
} //! \end of saturate_torque function

//! \brief returns current from LQR gains and integrator on wheel velocity (omega)
//! \param[in] omega, theta, theta_dot 3 floats which are the state of the system (rad, rad/s, rad/s)
//! \param[in] counter, used so keep track of time
//! \param[out] current which needs to be sent to udriver. is saturated to max. [A]
float return_current(float theta, float theta_dot, float omega, uint32_t counter) {
  integrate_omega += omega / (float)LOOP_FREQ;
  float torque_ref = 0.0;
  if (counter <= TRAJ_LENGTH) {                                     // stand up part
    torque_ref = ((float)torque_traj[counter - 1]) / 15000.0;       // feedforward torque
    desired_theta = ((float)theta_traj[counter - 1]) / 30000.0;     // ideal trajectory
    desired_thetad = ((float)dthetadt_traj[counter - 1]) / 10000.0; // ideal trajectory
    desired_omega = ((float)omega_traj[counter - 1]) / 70.0;        // ideal trajectory
  } else if (counter == TRAJ_LENGTH + 1) {                          // set to 0 once
    desired_omega = 0.0;
    desired_theta = 0.0;
    desired_thetad = 0.0;
    torque_ref = 0.0;
  }
  m_usb_tx_long(desired_theta / 2.0 / PI * 360.0 * 1000.0);
  m_usb_tx_string("\t");
  m_usb_tx_long(desired_thetad / 2.0 / PI * 360.0 * 1000.0);
  m_usb_tx_string("\t");
  m_usb_tx_int(thetadd / 2.0 / PI * 360.0 * 1000.0);
  m_usb_tx_string("\t");
  m_usb_tx_long(desired_omega / 2.0 / PI * 360.0 * 1000.0);
  m_usb_tx_string("\t");
  m_usb_tx_long(torque_ref * 1000.0);
  m_usb_tx_string("\t");

  if (counter > TRAJ_LENGTH) { // stabilization around 0,0,0
    return (saturate_torque(-K[0] * theta - K[1] * theta_dot - K[2] * omega + Ki * integrate_omega, omega, 0.0)) /
           MOTOR_TORQUE_CONSTANT;
  } else { // stand up
    return ((saturate_torque(torque_ref + K[0] * (desired_theta - theta) + K[1] * (desired_thetad - theta_dot) +
                                 K[2] * (desired_omega - omega) + Ki * integrate_omega,
                             omega, 0.0)) /
            MOTOR_TORQUE_CONSTANT);
  }
} //! \end of return_current function
